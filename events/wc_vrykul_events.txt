namespace = WCVRK

# Spawns a kvaldir ravager
long_character_event = {
	id = WCVRK.10
	desc = EVTDESC_WCVRK_10
	picture = GFX_evt_kvaldir
	border = GFX_event_long_frame_war
	
	is_triggered_only = yes
	
	only_playable = yes

	trigger = {
		is_untouchable_trigger = no
		can_rule_peacefully_trigger = yes
		
		is_alive = yes
		is_dying = no
		
		NOT = { religion = helya }
		capital_scope = { region = world_northrend }
		any_demesne_province = { port = yes }
	}
	
	weight_multiplier = {
		days = 1
	}

	immediate = {
		create_character = {
			dynasty = none
			religion = helya
			culture = kvaldir
			age = 500
			trait = creature_kvaldir
			trait = being_undead
			trait = cruel
			trait = ambitious
			trait = brave
			trait = arbitrary
			trait = wroth
			random_traits = no
		}
		new_character = {
			remove_education_effect = yes
			random_list = {
				10 = {
					add_trait = misguided_warrior
					add_trait = class_warrior_4
				}
				45 = {
					add_trait = tough_soldier
					add_trait = class_warrior_5
				}
				30 = {
					add_trait = skilled_tactician
					add_trait = class_warrior_6
				}
				15 = {
					add_trait = brilliant_strategist
					add_trait = class_warrior_7
				}
			}
			set_character_flag = wc_raiding_adventurer_flag
			character_event = { id = HL.100 }
		}
	}
	
	option = {
		name = ALAS
	}
}

### CRISIS: DRUST INCURSION EVENTS ###
# Waycrest's spouse is sick - begin the Incursion
character_event = {
	id = WCVRK.100
	
	is_triggered_only = yes
	only_playable = yes
	hide_window = yes

	trigger = {
		is_untouchable_trigger = no

		is_alive = yes
		is_dying = no
		is_adult = yes
		is_incapable = no
		prisoner = no
		is_inaccessible_trigger = no
    
		OR = {
			is_feudal = yes
			is_tribal = yes
		}

		NOT = { has_global_flag = heartsbane_coven_event_flag }
		NOT = { has_character_flag = heartsbane_coven_declined_flag }
    
		can_be_undead_trigger = yes
		dark_public_religion_trigger = no
		dark_true_religion_trigger = no
		
		trigger_if = {
			limit = { is_female = no }
			character_disease_trigger = yes
		}
    
		spouse = {
			is_untouchable_trigger = no

			is_alive = yes
			is_dying = no
			is_adult = yes
			is_incapable = no
			prisoner = no
			is_inaccessible_trigger = no
        
			OR = {
				is_feudal = yes
				is_tribal = yes
				is_ruler = no
			}
        
			can_be_undead_trigger = yes
			dark_public_religion_trigger = no
			dark_true_religion_trigger = no
        
			trigger_if = {
				limit = { is_female = no }
				character_disease_trigger = yes
			}
		}
		
		OR = {
			has_landed_title = d_drustwar
			spouse = {
				has_landed_title = d_drustwar
			}
		}
	}
	
	immediate = {
		set_global_flag = heartsbane_coven_event_flag
		if = {
			limit = { is_female = no }
			save_event_target_as = target_mothers_spouse
		}
		else = {
			save_event_target_as = target_mother
		}
		spouse = {
			if = {
				limit = { is_female = no }
				save_event_target_as = target_mothers_spouse
			}
			else = {
				save_event_target_as = target_mother
			}
		}
		
		event_target:target_mother = { narrative_event = { id = WCVRK.110 } }
	}
}

#Gorak Tul contacts the grief-stricken spouse
narrative_event = {
	id = WCVRK.110
	title = EVTTITLE_WCVRK_110
	desc = EVTDESC_WCVRK_110
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	immediate = {
		log = "WCVRK.110 fired for [Root.GetBestName]"
		if = {
			limit = {
				any_child = {
					is_adult = yes
					is_incapable = no
					prisoner = no
					is_inaccessible_trigger = no
            
					is_ruler = no	# ...since she's gonna become head of holy order
					is_dark_being_trigger = no
					dark_public_religion_trigger = no
					dark_true_religion_trigger = no
				}
			}
			random_child = {
				limit = {
					is_adult = yes
					is_incapable = no
					prisoner = no
					is_inaccessible_trigger = no
            
					is_ruler = no	# ...since she's gonna become head of holy order
					is_dark_being_trigger = no
					dark_public_religion_trigger = no
					dark_true_religion_trigger = no
				}
				save_event_target_as = target_ooe_founder
				add_trait = zealous
			}
		}
		else = {
			create_character = {
				random_traits = yes
				dynasty = none
				religion = tidemother
				culture = tirassian
				female = yes
				age = 26
				attributes = {
					martial = 7
				}
				trait = creature_human
				trait = brilliant_strategist
				trait = class_paladin_7
				trait = zealous
			}
			new_character = {
				save_event_target_as = target_ooe_founder
			}
		}
	}

	# Not even death will do us part
	option = {
		name = EVTOPTA_WCVRK_110
		event_target:target_mother = {
			set_graphical_culture = human_undead
			add_trait_undead_effect = yes
			remove_trait = creature_human
			add_trait = creature_banshee
			religion = throssian
		}
		event_target:target_mothers_spouse = {
			set_graphical_culture = human_undead
			add_trait_undead_effect = yes
			religion = throssian
			narrative_event = { id = WCVRK.111 }
		}
		event_target:target_ooe_founder = { 
			narrative_event = { id = WCVRK.120 days = 1 } 
		}
		if = {
			limit = { event_target:target_mother = { is_landed = yes } }
			event_target:target_mother = {
				save_event_target_as = target_unit_owner
				capital_scope = {
					save_event_target_as = target_unit_province
				}
			}
		}
		else_if = {
			limit = { event_target:target_mothers_spouse = { is_landed = yes } }
			event_target:target_mothers_spouse = {
				save_event_target_as = target_unit_owner
				capital_scope = {
					save_event_target_as = target_unit_province
				}
			}
		}
		if = {
			limit = { event_target:target_unit_owner = { character = yes } }
			spawn_unit = {
				owner = event_target:target_unit_owner
				province = event_target:target_unit_province
				home = event_target:target_unit_province
				troops = {
					archers = { 1000 1000 }
					light_infantry = { 1500 1500 }
					heavy_infantry = { 1875 1875 }
					light_cavalry = { 250 250 }
					knights = { 375 375 }
				}
				cannot_inherit = no
				attrition = 1.0
				reinforces = yes
				maintenance = no
			}
		}
		if = {
			limit = {
				event_target:target_mother = {
					de_facto_liege = event_target:target_mothers_spouse
				}
			}
			event_target:target_mothers_spouse = {
				set_defacto_liege = THIS
			}
		}
		else_if = {
			limit = {
				event_target:target_mothers_spouse = {
					de_facto_liege = event_target:target_mother
				}
			}
			event_target:target_mother = {
				set_defacto_liege = THIS
			}
		}
		else = {
			event_target:target_mother = {
				set_defacto_liege = THIS
			}
			event_target:target_mothers_spouse = {
				set_defacto_liege = THIS
			}
		}
			
		ai_chance = {
			factor = 1
		}
	}
		
	# I refuse
	option = {
		name = EVTOPTB_WCVRK_110
		clr_global_flag = heartsbane_coven_event_flag
		set_character_flag = heartsbane_coven_declined_flag
		custom_tooltip = {
			text = stops_the_event_chain
		}
		new_character = {
			effect = {
				death = { death_reason = death_missing }
			}
		}
		ai_chance = {
			factor = 0
		}
	}
}

#Ping the spouse (he never asked for this)
narrative_event = {
	id = WCVRK.111
	title = EVTTITLE_WCVRK_111
	desc = EVTDESC_WCVRK_111
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue

	is_triggered_only = yes
	
	immediate = {
		log = "WCTHW.111 fired for [Root.GetBestName]"
	}
	
	option = {
		name = EVTOPTA_WCVRK_111
	}
}


#The Order of Embers
narrative_event = {
	id = WCVRK.120
	title = EVTTITLE_WCVRK_120
	desc = EVTDESC_WCVRK_120
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_war
	
	major = yes
	major_triggger = {
		ai = no
	}
	
	is_triggered_only = yes
	
	immediate = {
		log = "WCTHW.120 fired for [Root.GetBestName]"
		activate_title = { title = d_order_of_embers status = yes }
		d_order_of_embers = { grant_title = event_target:target_ooe_founder }
		if = {
			limit = {
				k_kul_tiras = {
					holder_scope = {
						religion = tidemother
						is_dark_being_trigger = no
					}
				}
			}
			set_defacto_liege = k_kul_tiras
		}
		religion_authority = {
			modifier = religious_order_formed
			years = 10
		}
		event_target:target_ooe_founder = { 
			wealth = 500
		}
		3537 = {
			ROOT = {
				spawn_unit = {
					owner = ROOT
					province = PREV
					home = PREV
					troops = {
						archers = { 1000 1000 }
						light_infantry = { 1500 1500 }
						heavy_infantry = { 1875 1875 }
						light_cavalry = { 250 250 }
						knights = { 375 375 }
					}
					cannot_inherit = no
					attrition = 1.0
					reinforces = yes
					maintenance = no
				}
			}
		}
		# Declares war against the duchy of Drustvar
		d_drustwar = {
			holder_scope = {
				if = {
					limit = {
						OR = {
							character = event_target:target_mother
							character = event_target:target_mothers_spouse
						}
					}
					event_target:target_ooe_founder = {
						unsafe_war = {
							target = PREV
							casus_belli = religious
							thirdparty_title = PREVPREV
						}
					}
				}
			}
		}
	}
	
	option = {
		trigger = { 
			true_religion = throssian
		} 
		name = EVTOPTA_WCVRK_120
	}
	option = {
		trigger = {
			NOT = {
				true_religion = throssian
			}
		}
		name = EVTOPTB_WCVRK_120
	}
}

#Gorak Tul invades - triggered by decision
narrative_event = {
	id = WCVRK.130
	title = EVTTITLE_WCVRK_130
	desc = EVTDESC_WCVRK_130
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	major = yes
	major_triggger = {
		ai = no
	}
	
	immediate = {
		log = "WCTHW.130 fired for [Root.GetBestName]"
		set_global_flag = drust_incursion_happened
		create_character = {
			name = Gorak
			dynasty = 70201
			culture = drust
			religion = throssian
			attributes = {
				martial=5 diplomacy=5 stewardship=5 intrigue=6 learning=6
			}
			trait=mastermind_theologian
			trait=creature_vrykul
			trait=class_necromancer_9
			trait=cruel trait=patient trait=zealous trait=deceitful trait=being_undead
			age = 500
		}
		new_character = {
			save_event_target_as = target_gorak_tul
			effect = {
				set_graphical_culture = vrykul_undead
			}
		}
		activate_title = { title = k_drustvar status = yes }
		k_drustvar = { grant_title = event_target:target_gorak_tul }
		c_fates_end = { grant_title = event_target:target_gorak_tul }
		event_target:target_gorak_tul = { 
			wealth = 1000
			set_government_type = tribal_monarchy_government
		}
		3553 = {
			ROOT = {
				spawn_unit = {
					owner = event_target:target_gorak_tul
					province = PREV
					home = PREV
					troops = {
						archers = { 2000 2000 }
						light_infantry = { 3000 3000 }
						heavy_infantry = { 3750 3750 }
						light_cavalry = { 500 500 }
						knights = { 750 750 }
					}
					cannot_inherit = no
					attrition = 1.0
					reinforces = yes
					maintenance = no
				}
				spawn_fleet = {
					province = closest # closest sea zone
					owner = event_target:target_gorak_tul
					disband_on_peace = yes
					troops = {
						galleys = { 100 100 }
					}
				}
			}
		}
		# make the person that fired the decison a vassal of Gorak Tul
		event_target:target_summoner_of_gorak = {
			set_defacto_liege = event_target:target_gorak_tul
		}
		# Declares war against Kul Tiras (wip)
		k_kul_tiras = {
			holder_scope = {
                event_target:target_gorak_tul = {
                    unsafe_war = {
                        target = PREV
                        casus_belli = invasion
                        thirdparty_title = PREVPREV
                    }
                }
            }
        }
	}		
	
	option = {
		name = EVTOPTA_WCVRK_130
	}
}

# The Heartsbane are defeated
	id = WCVRK.131
	title = EVTTITLE_WCVRK_131
	desc = EVTDESC_WCVRK_131
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	major = yes
	major_triggger = {
		ai = no
	}
	
	immediate = {
		#cleanup
	}
	
	option = {
		name = "EVTOPTA_WCVRK_131"
	}

# The Drust sack Boralus
narrative_event = {
	id = WCVRK.140
	title = "EVTTITLE_WCVOD_140"
	desc = "EVTDESC_WCVRK_140"
	major = yes
	
	picture = "GFX_evt_boralus_siege"
	border = "GFX_event_narrative_frame_war"
	
	is_triggered_only = yes
	
	culture = drust
	
	trigger = {
		NOT = { has_global_flag = drust_sack_boralus }
		OR = {
			has_landed_title = k_drustvar	
			liege = { has_landed_title = k_drustvar }
			top_liege = { has_landed_title = k_drustvar }
		}
		FROM = { title = b_boralus }
		NOT = {
			FROM = {
				owner = {
					OR = {
						has_landed_title = k_drustvar
						liege = { has_landed_title = k_drustvar }
						top_liege = { has_landed_title = k_drustvar }
					}
				}
			}
		}		
	}
	
	major_trigger = {
		NOT = {
			has_landed_title = k_drustvar
			liege = { has_landed_title = k_drustvar }
			top_liege = { has_landed_title = k_drustvar }
		}
	}
	
	immediate = {
		set_global_flag = drust_sack_boralus
		any_player = {
			limit = {
				OR = {
					has_landed_title = k_drustvar
					liege = { has_landed_title = k_drustvar }
					top_liege = { has_landed_title = k_drustvar }
				}
			}
			narrative_event = { id = WCVRK.140 }
		}
		3256 = {
			add_max_depopulation_effect = yes
		}

		3256 = {
			hidden_effect = {
				any_province_character = {
					limit = {
						NOT = { character = ROOT }
						
						in_command = no
					}
					random = {
						chance = 75
						death = {
							death_reason = death_battle
							killer = ROOT
						}
					}
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTA_WCVRK_140"
		trigger = { NOT = { religion = throssian } }
	}
	option = {
		name = "EVTOPTB_WCVRK_140"
		trigger = { religion = throssian }
	}
}

# The Fall of Boralus - Drust side
narrative_event = {
	id = WCVRK.141
	title = "EVTTITLE_WCVRK_141"
	desc = "EVTDESC_WCVRK_141"
	picture = "GFX_evt_boralus_siege"
	border = "GFX_event_narrative_frame_war"
	
	is_triggered_only = yes
	
	hide_from = yes
	
	option = {
		name = "EVTOPTA_WCVRK_141"
		prestige = 100
	}
}