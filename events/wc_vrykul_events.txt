namespace = WCVRK

# Spawns a kvaldir ravager
long_character_event = {
	id = WCVRK.10
	desc = EVTDESC_WCVRK_10
	picture = GFX_evt_kvaldir
	border = GFX_event_long_frame_war
	
	is_triggered_only = yes
	
	only_playable = yes

	trigger = {
		is_untouchable_trigger = no
		can_rule_peacefully_trigger = yes
		
		is_alive = yes
		is_dying = no
		
		NOT = { religion = helya }
		capital_scope = { region = world_northrend }
		any_demesne_province = { port = yes }
	}
	
	weight_multiplier = {
		days = 1
	}

	immediate = {
		create_character = {
			dynasty = none
			religion = helya
			culture = kvaldir
			age = 500
			trait = creature_kvaldir
			trait = being_undead
			trait = cruel
			trait = ambitious
			trait = brave
			trait = arbitrary
			trait = wroth
			random_traits = no
		}
		new_character = {
			remove_education_effect = yes
			random_list = {
				10 = {
					add_trait = misguided_warrior
					add_trait = class_warrior_4
				}
				45 = {
					add_trait = tough_soldier
					add_trait = class_warrior_5
				}
				30 = {
					add_trait = skilled_tactician
					add_trait = class_warrior_6
				}
				15 = {
					add_trait = brilliant_strategist
					add_trait = class_warrior_7
				}
			}
			set_character_flag = wc_raiding_adventurer_flag
			character_event = { id = HL.100 }
		}
	}
	
	option = {
		name = ALAS
	}
}

### DRUST INCURSION EVENTS ###
# Waycrest's spouse is sick - begin the Incursion
character_event = {
	id = WCVRK.100
	
	is_triggered_only = yes
	only_playable = yes
	hide_window = yes

	trigger = {
		is_untouchable_trigger = no

		is_alive = yes
		is_dying = no
		is_adult = yes
		is_incapable = no
		prisoner = no
		is_inaccessible_trigger = no
		capital_scope = { de_jure_liege_or_above = d_drustwar }
    
		OR = {
			is_feudal = yes
			is_tribal = yes
		}

		NOT = { has_global_flag = drust_incursion_happened_flag }
		NOT = { has_character_flag = drust_incursion_declined_flag }
    
		can_be_undead_trigger = yes
		dark_public_religion_trigger = no
		dark_true_religion_trigger = no
		
		trigger_if = {
			limit = { is_female = no }
			character_disease_trigger = yes
		}
    
		spouse = {
			is_untouchable_trigger = no

			is_alive = yes
			is_dying = no
			is_adult = yes
			is_incapable = no
			prisoner = no
			is_inaccessible_trigger = no
        
			OR = {
				is_ruler = no
				is_feudal = yes
				is_tribal = yes
			}
        
			can_be_undead_trigger = yes
			dark_public_religion_trigger = no
			dark_true_religion_trigger = no
        
			trigger_if = {
				limit = { is_female = no }
				character_disease_trigger = yes
			}
		}
	}
	
	immediate = {
		set_global_flag = drust_incursion_happened_flag
		if = {
			limit = { is_female = no }
			save_event_target_as = target_mothers_spouse
		}
		else = {
			save_event_target_as = target_mother
		}
		spouse = {
			if = {
				limit = { is_female = no }
				save_event_target_as = target_mothers_spouse
			}
			else = {
				save_event_target_as = target_mother
			}
		}
		
		event_target:target_mother = { narrative_event = { id = WCVRK.110 } }
	}
}

#Gorak Tul contacts the grief-stricken spouse
narrative_event = {
	id = WCVRK.110
	title = EVTTITLE_WCVRK_110
	desc = EVTDESC_WCVRK_110
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	immediate = {
		log = "WCVRK.110 fired for [Root.GetBestName]"
		if = {
			limit = {
				any_child = {
					is_adult = yes
					is_incapable = no
					prisoner = no
					is_inaccessible_trigger = no
            
					is_ruler = no	# ...since she's gonna become head of holy order
					is_dark_being_trigger = no
					dark_public_religion_trigger = no
					dark_true_religion_trigger = no
				}
			}
			random_child = {
				limit = {
					is_adult = yes
					is_incapable = no
					prisoner = no
					is_inaccessible_trigger = no
            
					is_ruler = no	# ...since she's gonna become head of holy order
					is_dark_being_trigger = no
					dark_public_religion_trigger = no
					dark_true_religion_trigger = no
				}
				save_event_target_as = target_ooe_founder
			}
		}
		else = {
			create_character = {
				random_traits = yes
				dynasty = none
				religion = tidemother
				culture = tirassian
				female = yes
				age = 26
				attributes = {
					martial = 7
				}
				trait = creature_human
				trait = brilliant_strategist
				trait = class_paladin_7
			}
			new_character = {
				save_event_target_as = target_ooe_founder
			}
		}
	}

	# Not even death will do us part
	option = {
		name = EVTOPTA_WCVRK_110
		event_target:target_mother = {
			set_graphical_culture = human_undead
			add_trait_undead_effect = yes
			remove_trait = creature_human
			add_trait = creature_banshee
			religion = throssian
		}
		event_target:target_mothers_spouse = {
			set_graphical_culture = human_undead
			add_trait_undead_effect = yes
			religion = throssian
			narrative_event = { id = WCVRK.111 }
		}
		event_target:target_ooe_founder = { 
			narrative_event = { id = WCVRK.120 days = 1 } 
		}
		if = {
			limit = { event_target:target_mother = { is_landed = yes } }
			event_target:target_mother = {
				save_event_target_as = target_unit_owner
				capital_scope = {
					save_event_target_as = target_unit_province
				}
			}
		}
		else_if = {
			limit = { event_target:target_mothers_spouse = { is_landed = yes } }
			event_target:target_mothers_spouse = {
				save_event_target_as = target_unit_owner
				capital_scope = {
					save_event_target_as = target_unit_province
				}
			}
		}
		if = {
			limit = { event_target:target_unit_owner = { character = yes } }
			spawn_unit = {
				owner = event_target:target_unit_owner
				province = event_target:target_unit_province
				home = event_target:target_unit_province
				troops = {
					archers = { 1000 1000 }
					light_infantry = { 1500 1500 }
					heavy_infantry = { 1875 1875 }
					light_cavalry = { 250 250 }
					knights = { 375 375 }
				}
				cannot_inherit = no
				attrition = 1.0
				reinforces = yes
				maintenance = no
			}
		}
		ai_chance = {
			factor = 1
		}
	}
		
	# I refuse
	option = {
		name = EVTOPTB_WCVRK_110
		clr_global_flag = drust_incursion_happened_flag
		set_character_flag = drust_incursion_declined_flag
		custom_tooltip = {
			text = stops_the_event_chain
		}
		new_character = {
			effect = {
				death = { death_reason = death_missing }
			}
		}
		ai_chance = {
			factor = 0
		}
	}
}

#Ping the spouse
narrative_event = {
	id = WCVRK.111
	title = EVTTITLE_WCVRK_111
	desc = EVTDESC_WCVRK_111
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue

	is_triggered_only = yes
	
	immediate = {
		log = "WCTHW.111 fired for [Root.GetBestName]"
	}
	
	option = {
		name = EVTOPTA_WCVRK_111
	}
}


#The Order of Embers
narrative_event = {
	id = WCVRK.120
	title = EVTTITLE_WCVRK_120
	desc = EVTDESC_WCVRK_120
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_war
	
	major = yes
	major_triggger = {
		ai = no
	}
	
	is_triggered_only = yes
	
	immediate = {
		log = "WCTHW.120 fired for [Root.GetBestName]"
		activate_title = { title = d_order_of_embers status = yes }
		d_order_of_embers = { grant_title = event_target:target_ooe_founder }
		if = {
			limit = {
				k_kul_tiras = {
					holder_scope = {
						religion = tidemother
						is_dark_being_trigger = no
					}
				}
			}
			set_defacto_liege = k_kul_tiras
		}
		religion_authority = {
			modifier = religious_order_formed
			years = 10
		}
		event_target:target_ooe_founder = { 
			wealth = 500
			add_claim = d_drustwar
		}
		3537 = {
			ROOT = {
				spawn_unit = {
					owner = ROOT
					province = PREV
					home = PREV
					troops = {
						archers = { 1000 1000 }
						light_infantry = { 1500 1500 }
						heavy_infantry = { 1875 1875 }
						light_cavalry = { 250 250 }
						knights = { 375 375 }
					}
					cannot_inherit = no
					attrition = 1.0
					reinforces = yes
					maintenance = no
				}
			}
		}
		# Declares war against Waycrest
		3535 = {
			holder_scope = {
				top_liege = {
					if = {
						limit = {
							is_untouchable_trigger = no

							NOT = { religion = tidemother }
							NOT = { true_religion = tidemother }
						}
						ROOT = {
							unsafe_war = {
								target = PREV
								casus_belli = claim
								thirdparty_title = PREV
							}
						}
					}
				}
			}
		}
		event_target:target_mother = { narrative_event = { id = WCVRK.130 days = 365 } }
	}
	
	option = {
		trigger = { 
			true_religion = throssian
		} 
		name = EVTOPTA_WCVRK_120
	}
	option = {
		trigger = {
			NOT = {
				true_religion = throssian
			}
		}
		name = EVTOPTB_WCVRK_120
	}
}

#Gorak Tul invades
narrative_event = {
	id = WCVRK.130
	title = EVTTITLE_WCVRK_130
	desc = EVTDESC_WCVRK_130
	picture = GFX_evt_drustvar
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	major = yes
	major_triggger = {
		ai = no
	}
	
	immediate = {
		log = "WCTHW.130 fired for [Root.GetBestName]"
		if = {
			limit = {
				d_drustwar = {
					holder_scope = {
						religion = throssian
					}
				}
			}
			create_character = {
				name = Gorak
				dynasty = 70201
				culture = drust
				religion = throssian
				attributes = {
					martial=5 diplomacy=5 stewardship=5 intrigue=6 learning=6
				}
				trait=mastermind_theologian
				trait=creature_vrykul
				trait=class_necromancer_9
				trait=cruel trait=patient trait=zealous trait=deceitful trait=being_undead
				age = 500
			}
			new_character = {
				save_event_target_as = target_gorak_tul
				effect = {
					set_graphical_culture = vrykul_undead
				}
			}
			activate_title = { title = k_drustvar status = yes }
			k_drustvar = { grant_title = event_target:target_gorak_tul }
			c_fates_end = { grant_title = event_target:target_gorak_tul }
			event_target:target_gorak_tul = { 
				wealth = 2000
			}
			3553 = {
				ROOT = {
					spawn_unit = {
						owner = event_target:target_gorak_tul
						province = PREV
						home = PREV
						troops = {
							archers = { 2000 2000 }
							light_infantry = { 3000 3000 }
							heavy_infantry = { 3750 3750 }
							light_cavalry = { 500 500 }
							knights = { 750 750 }
						}
						cannot_inherit = no
						attrition = 1.0
						reinforces = yes
						maintenance = no
					}
				}
			}
			# make the d_drustwar owner change allegiance
			if = {
				limit = {
					event_target:target_mother = {
						is_landed = yes
					}
				}
				set_defacto_liege = event_target:target_gorak_tul
			}
			else = {
				limit = {
					event_target:target_mothers_spouse = {
						is_landed = yes
					}
				}
				set_defacto_liege = event_target:target_gorak_tul
			}
			# Declares war against Kul Tiras
			3526 = {
				holder_scope = {
					top_liege = {
						if = {
							limit = {
								is_untouchable_trigger = no

								NOT = { religion = throssian }
								NOT = { true_religion = throssian }
							}
							event_target:target_gorak_tul = {
								set_character_flag = event_war_exception_flag
								unsafe_war = {
									target = PREV
									casus_belli = total_invasion
									thirdparty_title = PREV
								}
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_WCVRK_130
	}
}