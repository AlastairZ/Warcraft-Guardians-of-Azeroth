namespace = WCLAT

### The creation of the Ashbringer ###
# Founds a dark crystal
narrative_event = {
	id = WCLAT.8000
	title = EVTTITLE_WCLAT_8000
	desc = EVTDESC_WCLAT_8000
	picture = GFX_evt_desert
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes

	only_playable = yes
	min_age = 16
	only_capable = yes
	prisoner = no
	religion_group = light_group

	trigger = {
		NOT = { has_global_flag = ashbringer_event_chain_flag }
		NOT = { has_character_flag = ashbringer_event_chain_happened_flag }

		ashbringer_owner_event_trigger = yes

		has_global_flag = dark_portal_was_opened_flag
	}

	weight_multiplier = {
		days = 1
		modifier = {
			factor = 2
			ai = no
		}
		modifier = {
			factor = 1.5
			trait = brave
		}
		modifier = {
			factor = 1.25
			trait = temperate
		}
		modifier = {
			factor = 1.25
			trait = stubborn
		}
		modifier = {
			factor = 1.25
			trait = ambitious
		}
	}

	immediate = {
		set_global_flag = ashbringer_event_chain_flag
		set_character_flag = ashbringer_event_chain_happened_flag
	}

	# Touch the crystal
	option = {
		name = EVTOPTA_WCLAT_8000

		tooltip = { add_artifact = dark_crystal }
		
		hidden_effect = { narrative_event = { id = WCLAT.8005 } }
	}

	# Pass by
	option = {
		name = EVTOPTB_WCLAT_8000

		custom_tooltip = {
			text = stops_the_event_chain
			hidden_effect = { clr_global_flag = ashbringer_event_chain_flag }
		}

		ai_chance = {
			factor = 0
		}
	}

	after = {
		if = {
			limit = { is_alive = no }
			clr_global_flag = ashbringer_event_chain_flag
		}
	}
}
# You touched it
narrative_event = {
	id = WCLAT.8005
	title = EVTTITLE_WCLAT_8000
	desc = EVTDESC_WCLAT_8005
	picture = GFX_evt_desert
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes

	# I need to be careful with it
	option = {
		name = EVTOPTA_WCLAT_8005

		health = -0.5

		add_artifact = dark_crystal
		new_artifact = {
			set_creation_date = 1.1.1
		}
	}

	# Throw out this thing!
	option = {
		name = EVTOPTB_WCLAT_8005

		health = -0.5

		custom_tooltip = {
			text = stops_the_event_chain
			hidden_effect = { clr_global_flag = ashbringer_event_chain_flag }
		}

		ai_chance = {
			factor = 0
		}
	}
}
# Dark days came, this dark crystal is the last hope
narrative_event = {
	id = WCLAT.8010
	title = EVTTITLE_WCLAT_8010
	desc = EVTDESC_WCLAT_8010
	picture = GFX_evt_ritual_scroll
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes

	only_playable = yes
	min_age = 16
	only_capable = yes
	prisoner = no
	religion_group = light_group

	trigger = {
		NOT = { has_character_flag = ongoing_creation_ashbringer_flag }
		
		ashbringer_owner_event_trigger = yes

		has_artifact = dark_crystal
	}

	immediate = {
		set_character_flag = ongoing_creation_ashbringer_flag
	}

	weight_multiplier = {
		days = 1
		modifier = {
			factor = 4
			ongoing_invasion_trigger = yes
		}
		modifier = {
			factor = 2
			ai = no
		}
		modifier = {
			factor = 1.5
			trait = brave
		}
		modifier = {
			factor = 1.25
			trait = temperate
		}
		modifier = {
			factor = 1.25
			trait = stubborn
		}
		modifier = {
			factor = 1.25
			trait = ambitious
		}
	}

	# We must try
	option = {
		name = EVTOPTA_WCLAT_8010

		hidden_effect = { narrative_event = { id = WCLAT.8015 } }
	}

	# Throw out this thing!
	option = {
		name = EVTOPTB_WCLAT_8005

		unsafe_destroy_artifact = dark_crystal

		custom_tooltip = {
			text = stops_the_event_chain
			hidden_effect = {
				clr_global_flag = ashbringer_event_chain_flag
				clr_character_flag = ongoing_creation_ashbringer_flag
			}
		}
		
		ai_chance = {
			factor = 0
		}
	}
}
# Purifies the crystal
narrative_event = {
	id = WCLAT.8015
	title = EVTTITLE_WCLAT_8010
	desc = EVTDESC_WCLAT_8015
	picture = GFX_evt_ritual_scroll
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes
	
	trigger = {
		ashbringer_owner_event_trigger = yes
		
		has_artifact = dark_crystal
	}
	
	fail_trigger_effect = {
		clr_character_flag = ongoing_creation_ashbringer_flag
	}

	# Forge a weapon!
	option = {
		name = EVTOPTA_WCLAT_8015

		hidden_effect = { narrative_event = { id = WCLAT.8020 days = 30 } }
	}
}
# Dwarves forged the weapon
narrative_event = {
	id = WCLAT.8020
	title = EVTTITLE_WCLAT_8010
	desc = EVTDESC_WCLAT_8020
	picture = GFX_evt_ashbringer
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes
	
	trigger = {
		ashbringer_owner_event_trigger = yes
		
		has_artifact = dark_crystal
	}
	
	fail_trigger_effect = {
		clr_character_flag = ongoing_creation_ashbringer_flag
	}

	# Forge a weapon!
	option = {
		name = EVTOPTA_WCLAT_8020

		add_artifact = ashbringer
		if = {
			limit = { has_nickname = no }
			give_nickname = nick_the_ashbringer
		}
		if = {
			limit = {
				is_female = yes
			}
			create_bloodline = {
				type = ashbringer_bloodline
				inheritance = matrilineal
			}
		}
		else = {
			create_bloodline = {
				type = ashbringer_bloodline
			}
		}
		hidden_effect = { unsafe_destroy_artifact = dark_crystal }
	}
}

### The Scarlet Crusade and the Argent Dawn ###
# Picks characters and province
character_event = {
	id = WCLAT.9000

	is_triggered_only = yes
	hide_window = yes
	
	ai = no

	trigger = {
		OR = {
			multiplayer = no
			is_multiplayer_host_character = yes
		}

		NOT = { 	#Frozen Throne variants are handled in wc_frozen_throne_story_events
			start_date = 605.6.6
			has_game_rule = {
				name = frozen_throne_story
				value = on
			}
		}

		NOT = { d_scarlet_crusade = { has_holder = yes } }
		OR = {
			NOT = { has_global_flag = plague_of_lordaeron_happened_flag }
			had_global_flag = { flag = plague_of_lordaeron_happened_flag years = 3 }
		}

		# Lordaeron
		269 = {
			holder_scope = {
				OR = {
					NOT = { religion_group = light_group }
					NOT = { religion_group = human_group }
				}
				top_liege = {
					OR = {
						NOT = { religion_group = light_group }
						NOT = { religion_group = human_group }
					}
				}
			}
		}
		# Stratholme
		324 = {
			holder_scope = {
				OR = {
					NOT = { religion_group = light_group }
					NOT = { religion_group = human_group }
				}
				top_liege = {
					OR = {
						NOT = { religion_group = light_group }
						NOT = { religion_group = human_group }
					}
				}
			}
		}
	}

	immediate = {
		log = "WCLAT.9000 fired for [Root.GetBestName]"
		
		### Creates d_argent_dawn
		create_d_argent_dawn_effect = yes
		
		### Creates d_scarlet_crusade and d_church_scarlet_light
		create_d_scarlet_crusade_effect = yes
		create_d_church_scarlet_light_effect = yes
		
		### Changes religion_authority
		religious_split_holy_light_bad_effect = yes
		religious_split_scarlet_light_good_effect = yes
		
		d_scarlet_crusade = {
			holder_scope = {
				# Used in scripted effects
				save_event_target_as = target_settler
				
				c_whispering_gardens = {
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
				}
				d_hearthglen = {
					any_direct_de_jure_vassal_title = {
						# event_target:target_settler and its people settle here
						settle_as_target_settler_effect = yes
					}
				}
				
				c_whispering_gardens = {
					# Declares war against player
					target_settler_declare_war_effect = yes
				}
				
				clear_settler_flag_effect = yes
				
				# Notification
				narrative_event = { id = WCLAT.9001 }
			}
		}
	}
}
# Starts event
narrative_event = {
	id = WCLAT.9001
	title = EVTTITLE_WLAT_9001
	desc = EVTDESC_WLAT_9001
	picture = GFX_evt_high_commander
	portrait = event_target:target_grand_crusader
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	major = yes
	major_trigger = {
		OR = {
			ai = no
			religion_group = light_group
		}
	}
	show_root = yes

	# Support the Argent Dawn
	option = {
		trigger = { true_religion = holy_light }
		name = EVTOPTA_WCLAT_9001

		piety = 100

		ai_chance = {
			factor = 50
			
			supports_holy_light_score = yes
		}
	}

	# Support the Scarlet Crusade
	option = {
		trigger = {
			OR = {
				true_religion = scarlet_light
				
				is_potential_scarlet_follower_trigger = yes
			}
		}
		name = EVTOPTB_WCLAT_9001
		
		support_scarlet_light_effect = yes

		ai_chance = {
			factor = 50
			
			supports_scarlet_light_score = yes
		}
	}

	# Fools!
	option = {
		trigger = {
			NOR = {
				true_religion = holy_light
				true_religion = scarlet_light
			}
		}
		name = FOOLS
	}
	
	after = {
		tooltip = {
			religious_split_holy_light_bad_effect = yes
			religious_split_scarlet_light_good_effect = yes
		}
	}
}